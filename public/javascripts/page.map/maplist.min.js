var mapName = 'dashboard-map'
var textBusinessName = $('#txt-business-name')
var buttonBusinessName = $('#btn-business-add')

function initData(){
  $.ajax({
    url: '/api/maps/maplist',
    dataType: 'json',
    type: 'GET',
    success: function(data){      
      for (var i in data){
        var insideHTML =
        `<li style="position:relative;" id="${data[i]._id}li">
          <a href="/map/detail/${data[i]._id}">
            <div class="wrapper">
              <h3 class="title"><strong id="bname">${data[i].businessName}</strong></h3>
            </div>
          </a>
          <div id="actionbtn" style="padding: 0px 12px; position:absolute; bottom:10px; width:100%;">
            <div class="row">
              <div class="col-xs-6" style="padding-right:7.5px;">
                <a id="${data[i]._id}" class="btn btn-block btn-info edit" name="${data[i].businessName}" style="color:#fff !important;">
                  <i class="fa fa-pencil" aria-hidden="true"></i> Edit
                </a>
              </div>
              <div class="col-xs-6" style="padding-left:7.5px;">
                <a id="${data[i]._id}" class="btn btn-block btn-danger delete" name="${data[i].businessName}" style="color:#fff !important;">
                  <i class="fa fa-trash" aria-hidden="true"></i> Delete
                </a>
              </div>
            </div>
          </div>
        </li>`
        $('#content-list').append(insideHTML)
        $(`#actionbtn #${data[i]._id}delete`).on('click', function (e) {

        })
      }
      $('.edit').each(function () {
        var oldbusinessName = $(this).attr('name')
        var idEdit = $(this).attr('id')
        var newbusinessName

        $(this).click(function () {
          swal({
            title: 'Change Business Name',
            input: 'text',
            showCancelButton: true,
            confirmButtonText: 'Submit',
            showLoaderOnConfirm: true,
            preConfirm: function (bname) {
              return new Promise(function (resolve, reject) {
                setTimeout(function() {
                  if (bname === '') {
                    reject("Business Name Can't Be Empty... ")
                  } else {
                    resolve()
                  }
                }, 200)
              })
            },
            allowOutsideClick: false
          }).then(function (bname) {
            newbusinessName = bname
            swal({
              type: 'success',
              title: 'rename request finished!',
              html: 'Submitted Business Name: ' + bname
            }).then(function () {

              $.ajax({
                url: '/map/editMap',
                dataType: 'json',
                type: 'POST',
                data: {
                  userID: $('#hdn-userid').val().trim(),
                  businessName: oldbusinessName,
                  businessNameEdit: bname
                },
                success: function(data){
                  if(data.success) $(`#${idEdit}li #bname`).text(bname)
                }.bind(this),
                error: function(xhr, status, err){}.bind(this)
              })
            })
          })

          ////////////////////

        })
      })
      $('.delete').each(function () {
        var businessNameDelete = $(this).attr('name')
        var idDelete = $(this).attr('id')
        $(this).click(function () {
          swal({
            title: 'Are you sure?',
            text: `Delete `+ $(this).attr('name')+`, You won't be able to revert this!`,
            type: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, delete it!'
          }).then(function () {
            swal(
              'Deleted!',
              'Your file has been deleted.',
              'success'
            ).then(function () {
              $.ajax({
                url: '/map/deleteMap',
                dataType: 'json',
                type: 'POST',
                data: {
                  userID: $('#hdn-userid').val().trim(),
                  businessName: businessNameDelete
                },
                success: function(data){
                  $(`#${idDelete}li`).remove()
                }.bind(this),
                error: function(xhr, status, err){}.bind(this)
              })
            })
          })
        })
      })
    }.bind(this),
    error: function(xhr, status, err){}.bind(this)
  })
}

function initAction(){
  buttonBusinessName.on('click', function(e){
    e.preventDefault()
    // AJAX ADD MAP GOES HERE - START
    $.ajax({
      url: '/map/addMap',
      dataType: 'json',
      type: 'POST',
      data: {
        userID: $('#hdn-userid').val().trim(),
        businessName: textBusinessName.val().trim()
      },
      success: function(data){
        window.location.replace(`/map/detail/${data.mapID}`)
      }.bind(this),
      error: function(xhr, status, err){}.bind(this)
    })

    //alert('HAHAH')
    // AJAX ADD MAP GOES HERE - END
  })
}

function initDashboard(){
  initData()
  initAction()
}

$(function(){
  verify(initDashboard(), false, 'p.signin.html')
})
